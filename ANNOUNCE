This fixes a major bug in the socket implementation.

When more than 16 sockets are used, the implementation was very likely
to fail.  I fixed the socket implementation.
